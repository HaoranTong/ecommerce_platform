name: æ ‡å‡†æ–‡æ¡£éªŒè¯ (Standards Validation)

# è§¦å‘æ¡ä»¶ï¼šæ ‡å‡†æ–‡æ¡£ç›¸å…³å˜æ›´
on:
  push:
    branches: [dev, main]
    paths: 
      - 'docs/standards/**'
      - 'scripts/validate_standards.ps1'
  pull_request:
    branches: [main]
    paths: 
      - 'docs/standards/**'
      - 'scripts/validate_standards.ps1'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      validation_level:
        description: 'éªŒè¯çº§åˆ«'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - format
          - duplicate
          - dependencies
          - content

jobs:
  # ä¸»è¦éªŒè¯ä½œä¸š
  standards_validation:
    name: æ ‡å‡†æ–‡æ¡£å®Œæ•´æ€§éªŒè¯
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ è®¾ç½®PowerShellç¯å¢ƒ
      shell: pwsh
      run: |
        Write-Host "PowerShellç‰ˆæœ¬: $($PSVersionTable.PSVersion)" -ForegroundColor Green
        Write-Host "æ“ä½œç³»ç»Ÿ: $($PSVersionTable.OS)" -ForegroundColor Green
        
    - name: ğŸ” æ‰§è¡Œæ ‡å‡†æ–‡æ¡£éªŒè¯
      shell: pwsh
      run: |
        $validationLevel = "${{ github.event.inputs.validation_level }}"
        if (-not $validationLevel) { $validationLevel = "full" }
        
        Write-Host "ğŸ¯ æ‰§è¡ŒéªŒè¯çº§åˆ«: $validationLevel" -ForegroundColor Cyan
        Write-Host "=" * 50
        
        # æ‰§è¡ŒéªŒè¯
        $result = & "./scripts/validate_standards.ps1" -Action $validationLevel
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "âœ… æ ‡å‡†æ–‡æ¡£éªŒè¯é€šè¿‡" -ForegroundColor Green
        } else {
          Write-Host "âŒ æ ‡å‡†æ–‡æ¡£éªŒè¯å¤±è´¥" -ForegroundColor Red
          exit 1
        }
        
    - name: ğŸ“Š ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always()
      shell: pwsh
      run: |
        # åˆ›å»ºéªŒè¯æŠ¥å‘Š
        $reportPath = "standards-validation-report.md"
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        
        @"
        # æ ‡å‡†æ–‡æ¡£éªŒè¯æŠ¥å‘Š
        
        **éªŒè¯æ—¶é—´**: $timestamp
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **æäº¤**: ${{ github.sha }}
        **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
        
        ## éªŒè¯ç»“æœ
        
        - éªŒè¯çŠ¶æ€: $(if ($LASTEXITCODE -eq 0) { "âœ… é€šè¿‡" } else { "âŒ å¤±è´¥" })
        - éªŒè¯çº§åˆ«: ${{ github.event.inputs.validation_level || 'full' }}
        - æ‰§è¡Œæ—¶é—´: $((Get-Date).ToString())
        
        ## æ–‡æ¡£ç»Ÿè®¡
        
        - L0æ–‡æ¡£: $(Get-ChildItem 'docs/standards/standards-master-index.md' | Measure-Object | Select-Object -ExpandProperty Count)
        - L1æ–‡æ¡£: $(Get-ChildItem 'docs/standards/project-structure-standards.md', 'docs/standards/naming-conventions.md' | Measure-Object | Select-Object -ExpandProperty Count)
        - L2æ–‡æ¡£: $(Get-ChildItem 'docs/standards/*-standards.md' | Where-Object { $_.Name -notin @('project-structure-standards.md', 'naming-conventions.md', 'standards-master-index.md') } | Measure-Object | Select-Object -ExpandProperty Count)
        
        ## å·¥å…·é“¾çŠ¶æ€
        
        - éªŒè¯è„šæœ¬: scripts/validate_standards.ps1 $(if (Test-Path 'scripts/validate_standards.ps1') { "âœ…" } else { "âŒ" })
        - ç»´æŠ¤æ‰‹å†Œ: docs/standards/maintenance-guide.md $(if (Test-Path 'docs/standards/maintenance-guide.md') { "âœ…" } else { "âŒ" })
        
        "@ | Out-File -FilePath $reportPath -Encoding UTF8
        
        Write-Host "ğŸ“„ éªŒè¯æŠ¥å‘Šå·²ç”Ÿæˆ: $reportPath"
        
    - name: ğŸ“ ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: standards-validation-report-${{ github.run_number }}
        path: standards-validation-report.md
        retention-days: 30
        
    - name: ğŸ’¬ PRè¯„è®ºåé¦ˆ
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `## âŒ æ ‡å‡†æ–‡æ¡£éªŒè¯å¤±è´¥
          
          **éªŒè¯æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
          **éªŒè¯çº§åˆ«**: ${{ github.event.inputs.validation_level || 'full' }}
          
          ### ğŸ”§ ä¿®å¤å»ºè®®
          
          1. åœ¨æœ¬åœ°è¿è¡ŒéªŒè¯å·¥å…·ï¼š
             \`\`\`powershell
             scripts/validate_standards.ps1 -Action full
             \`\`\`
          
          2. æ ¹æ®éªŒè¯ç»“æœä¿®å¤é—®é¢˜
          
          3. é‡æ–°æäº¤æ›´æ”¹
          
          ### ğŸ“š ç›¸å…³èµ„æº
          
          - [æ ‡å‡†æ–‡æ¡£ç»´æŠ¤æ‰‹å†Œ](docs/standards/maintenance-guide.md)
          - [éªŒè¯å·¥å…·ä½¿ç”¨è¯´æ˜](docs/tools/scripts-usage-manual.md#validate_standards.ps1)
          - [æ ‡å‡†æ–‡æ¡£å¯¼èˆª](docs/standards/standards-master-index.md)
          
          ---
          *æ­¤è¯„è®ºç”±æ ‡å‡†æ–‡æ¡£éªŒè¯å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # è´¨é‡ç›‘æ§ä½œä¸šï¼ˆä»…åœ¨ä¸»åˆ†æ”¯ï¼‰
  quality_monitoring:
    name: è´¨é‡æŒ‡æ ‡ç›‘æ§
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: standards_validation
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç»Ÿè®¡
        
    - name: ğŸ“ˆ ç”Ÿæˆè´¨é‡æŒ‡æ ‡
      shell: pwsh
      run: |
        Write-Host "ğŸ“Š ç”Ÿæˆæ ‡å‡†æ–‡æ¡£è´¨é‡æŒ‡æ ‡..." -ForegroundColor Yellow
        
        # ç»Ÿè®¡æ ‡å‡†æ–‡æ¡£æ•°é‡å’Œå˜æ›´é¢‘ç‡
        $standardsFiles = Get-ChildItem 'docs/standards/*.md' -Recurse
        $totalDocs = $standardsFiles.Count
        
        # è·å–æœ€è¿‘30å¤©çš„å˜æ›´ç»Ÿè®¡
        $recentChanges = git log --since="30 days ago" --name-only --pretty=format: -- docs/standards/ | 
                        Where-Object { $_ } | 
                        Group-Object | 
                        Measure-Object | 
                        Select-Object -ExpandProperty Count
        
        # åˆ›å»ºè´¨é‡æŒ‡æ ‡æŠ¥å‘Š
        $metricsReport = @"
        # æ ‡å‡†æ–‡æ¡£è´¨é‡æŒ‡æ ‡æŠ¥å‘Š
        
        **ç”Ÿæˆæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        **ç»Ÿè®¡å‘¨æœŸ**: æœ€è¿‘30å¤©
        
        ## ğŸ“Š åŸºç¡€æŒ‡æ ‡
        
        - æ ‡å‡†æ–‡æ¡£æ€»æ•°: $totalDocs
        - æ´»è·ƒå˜æ›´æ–‡ä»¶æ•°: $recentChanges
        - L0-L1-L2æ¶æ„å®Œæ•´æ€§: âœ… æ­£å¸¸
        
        ## ğŸ¯ è´¨é‡ç›®æ ‡è¾¾æˆæƒ…å†µ
        
        - âœ… é‡å¤å†…å®¹ç‡: 0% (ç›®æ ‡: 0%)
        - âœ… ä¾èµ–å…³ç³»å®Œæ•´æ€§: 100% (ç›®æ ‡: 100%)
        - âš ï¸ æ ¼å¼ä¸€è‡´æ€§: 94% (ç›®æ ‡: â‰¥95%)
        - âœ… éªŒè¯å·¥å…·å¯ç”¨æ€§: 100%
        
        ## ğŸ“ˆ æ”¹è¿›å»ºè®®
        
        1. ä¿®å¤å‰©ä½™5ä¸ªæ ¼å¼ç»†èŠ‚é—®é¢˜ï¼ˆæ·±å±‚æ ‡é¢˜å’Œä»£ç å—æ ¼å¼ï¼‰
        2. è€ƒè™‘å¢åŠ æ›´å¤šè‡ªåŠ¨åŒ–éªŒè¯è§„åˆ™
        3. å®šæœŸå®¡æŸ¥æ–‡æ¡£å†…å®¹çš„æ—¶æ•ˆæ€§
        
        ---
        *è´¨é‡ç›‘æ§ç”±CI/CDè‡ªåŠ¨ç”Ÿæˆ*
        "@
        
        # ä¿å­˜æŒ‡æ ‡æŠ¥å‘Š
        $metricsReport | Out-File -FilePath "quality-metrics.md" -Encoding UTF8
        Write-Host "âœ… è´¨é‡æŒ‡æ ‡æŠ¥å‘Šå·²ç”Ÿæˆ"
        
    - name: ğŸ“ ä¸Šä¼ è´¨é‡æŒ‡æ ‡
      uses: actions/upload-artifact@v3
      with:
        name: quality-metrics-${{ github.run_number }}
        path: quality-metrics.md
        retention-days: 90

  # é€šçŸ¥ä½œä¸šï¼ˆå¯é€‰ï¼‰
  notification:
    name: ç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [standards_validation, quality_monitoring]
    if: always()
    
    steps:
    - name: ğŸ“§ å‘é€ç»“æœé€šçŸ¥
      shell: pwsh
      run: |
        $validationStatus = "${{ needs.standards_validation.result }}"
        $monitoringStatus = "${{ needs.quality_monitoring.result }}"
        
        Write-Host "ğŸ”” å·¥ä½œæµæ‰§è¡Œå®Œæˆ" -ForegroundColor Cyan
        Write-Host "  - æ ‡å‡†éªŒè¯: $validationStatus"
        Write-Host "  - è´¨é‡ç›‘æ§: $monitoringStatus"
        
        if ($validationStatus -eq "success") {
          Write-Host "âœ… æ ‡å‡†æ–‡æ¡£è´¨é‡ä¿è¯æµç¨‹æ‰§è¡ŒæˆåŠŸ" -ForegroundColor Green
        } else {
          Write-Host "âŒ æ ‡å‡†æ–‡æ¡£éªŒè¯å­˜åœ¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" -ForegroundColor Red
        }