# 问题跟踪管理

## 文档说明
- **内容**：项目开发过程中的问题记录、分析、解决方案和状态跟踪
- **使用者**：开发团队、项目经理、技术负责人
- **更新频率**：问题发现和解决时实时更新
- **关联文档**：[每日工作日志](daily-log.md)、[当前冲刺状态](current-sprint.md)

---

## 问题概览仪表板

### 问题统计
- **总问题数**: 24
- **已解决**: 19 (79%)
- **进行中**: 3 (13%)
- **待处理**: 2 (8%)

### 按优先级分布
- **P0 - 紧急**: 0个
- **P1 - 高**: 2个 (1个进行中, 1个待处理)
- **P2 - 中**: 8个 (2个进行中, 6个已解决)
- **P3 - 低**: 13个 (11个已解决, 2个待处理)

### 按类型分布
- **缺陷 (Bug)**: 12个
- **性能问题**: 4个
- **安全问题**: 2个
- **设计问题**: 3个
- **环境问题**: 2个

---

## 活跃问题 (进行中/待处理)

### P1 - 高优先级

#### ISS-021 - 购物车并发操作数据不一致 🔴
- **状态**: 进行中
- **优先级**: P1 - 高
- **类型**: 缺陷
- **发现日期**: 2024-01-18
- **报告人**: 李四
- **负责人**: 张三
- **预计解决**: 2024-01-20

**问题描述**:
多用户同时修改购物车时，出现数据不一致问题。用户A添加商品的同时，用户B删除商品，导致购物车状态混乱。

**重现步骤**:
1. 用户A登录，添加商品到购物车
2. 同时用户B登录同一账户，删除购物车中商品
3. 观察购物车最终状态

**期望结果**: 购物车操作应该是原子性的，后执行的操作应该覆盖前面的操作

**实际结果**: 购物车中出现重复商品或商品数量异常

**技术分析**:
- **根本原因**: 缺乏分布式锁机制
- **影响范围**: 所有购物车操作
- **风险评估**: 影响用户体验，可能导致订单错误

**解决方案**:
1. **方案一**: 使用Redis分布式锁 (推荐)
   - 实现成本: 2天
   - 性能影响: 最小
   - 可靠性: 高

2. **方案二**: 数据库悲观锁
   - 实现成本: 1天
   - 性能影响: 较大
   - 可靠性: 中等

**当前进展**:
- [x] 问题复现和分析 (2024-01-18)
- [x] 技术方案设计 (2024-01-19)
- [ ] Redis锁实现 (进行中)
- [ ] 测试验证 (计划2024-01-20)

**相关代码**:
```python
# 计划实现的Redis锁机制
@redis_lock(key="cart:{user_id}", timeout=10)
async def update_cart_item(user_id: int, item_data: dict):
    # 购物车操作逻辑
    pass
```

---

#### ISS-023 - API响应时间偶发超过5秒 🔴
- **状态**: 待处理
- **优先级**: P1 - 高
- **类型**: 性能问题
- **发现日期**: 2024-01-19
- **报告人**: 王五
- **负责人**: 待分配
- **预计解决**: 2024-01-22

**问题描述**:
商品搜索API在高并发情况下偶发响应时间超过5秒，严重影响用户体验。

**重现条件**:
- 并发用户数 > 50
- 搜索关键词包含常用词汇
- 数据库商品数量 > 10000

**监控数据**:
- 平均响应时间: 200ms
- P95响应时间: 800ms
- P99响应时间: 5200ms
- 错误率: 0.1%

**技术分析**:
- **可能原因**: 数据库查询未优化、缺少索引、N+1查询问题
- **监控工具**: APM显示数据库查询占用80%时间

**初步排查**:
- [ ] 数据库慢查询日志分析
- [ ] SQL执行计划检查
- [ ] 缓存命中率评估
- [ ] 连接池配置验证

---

### P2 - 中优先级

#### ISS-022 - 用户上传图片内存占用过高 🟡
- **状态**: 进行中
- **优先级**: P2 - 中
- **类型**: 性能问题
- **发现日期**: 2024-01-17
- **报告人**: 李四
- **负责人**: 李四
- **预计解决**: 2024-01-21

**问题描述**:
用户上传大尺寸图片(>5MB)时，服务器内存使用量急剧上升，可能导致系统不稳定。

**技术细节**:
- **内存峰值**: 上传10MB图片时内存增加150MB
- **影响**: 服务器在高并发上传时可能OOM
- **当前限制**: 文件大小限制10MB

**解决进展**:
- [x] 问题分析和定位 (2024-01-17)
- [x] 流式上传方案设计 (2024-01-18)
- [ ] 实现流式文件处理 (进行中)
- [ ] 添加图片压缩功能 (计划)

**代码示例**:
```python
# 当前实现 (有问题)
def upload_file(file: UploadFile):
    content = file.read()  # 一次性读取到内存
    # 处理文件...

# 优化后实现
async def upload_file_stream(file: UploadFile):
    async for chunk in file.stream():  # 流式读取
        # 处理文件块...
```

---

#### ISS-020 - 数据库连接池配置不当 🟡
- **状态**: 进行中
- **优先级**: P2 - 中
- **类型**: 环境问题
- **发现日期**: 2024-01-16
- **报告人**: 张三
- **负责人**: 王五
- **预计解决**: 2024-01-20

**问题描述**:
在高并发测试中，数据库连接池耗尽，导致新请求等待时间过长。

**当前配置**:
```python
# 问题配置
DATABASE_URL = "mysql+pymysql://..."
engine = create_engine(
    DATABASE_URL,
    pool_size=5,          # 太小
    max_overflow=0,       # 无溢出连接
    pool_timeout=30,      # 超时过长
)
```

**优化方案**:
```python
# 优化配置
engine = create_engine(
    DATABASE_URL,
    pool_size=20,         # 增加基础连接数
    max_overflow=30,      # 允许溢出连接
    pool_timeout=10,      # 减少超时时间
    pool_recycle=3600,    # 连接回收时间
    pool_pre_ping=True,   # 连接预检
)
```

---

### P3 - 低优先级

#### ISS-019 - API文档示例数据不完整 🟢
- **状态**: 待处理
- **优先级**: P3 - 低
- **类型**: 设计问题
- **发现日期**: 2024-01-15
- **报告人**: 产品经理
- **负责人**: 待分配
- **预计解决**: 2024-01-25

**问题描述**:
Swagger API文档中部分接口缺少请求/响应示例，影响前端开发效率。

**缺失的接口文档**:
- [ ] 商品批量操作API
- [ ] 订单状态查询API
- [ ] 用户权限管理API

**解决计划**:
- 在下个Sprint中安排时间完善文档
- 建立API文档review流程

---

#### ISS-018 - 单元测试覆盖率不足 🟢
- **状态**: 待处理
- **优先级**: P3 - 低
- **类型**: 设计问题
- **发现日期**: 2024-01-14
- **报告人**: 张三
- **负责人**: 全体开发
- **预计解决**: 持续改进

**问题描述**:
部分模块的单元测试覆盖率低于80%目标，需要补充测试用例。

**当前覆盖率**:
- 用户认证模块: 95% ✅
- 商品管理模块: 75% ❌
- 购物车模块: 88% ✅
- 订单模块: 60% ❌ (新模块)

**改进计划**:
- 在每个功能开发完成后必须达到80%覆盖率
- 建立测试覆盖率检查门禁

---

## 已解决问题 (最近5个)

### ISS-025 - 用户模块Service测试Factory方法缺失 ✅
- **解决日期**: 2025-09-21
- **负责人**: AI Assistant  
- **问题描述**: `test_user_auth_service.py`中调用`create_sample_data()`方法失败，StandardTestDataFactory缺少该方法
- **根因分析**: 按照[CHECK:TEST-002]检查点，测试数据工厂不完整，缺少必要的样本数据生成方法
- **解决方案**: 在StandardTestDataFactory中添加`create_sample_data()`方法，返回用户测试场景所需的样本数据
- **用时**: 10分钟
- **验证**: ✅ 用户模块单元测试11个全部通过 (Models: 9个, Services: 2个)
- **影响**: 解决用户模块单元测试完整性，确保测试数据一致性
- **预防措施**: 严格执行MASTER.md检查点规范，测试失败时立即停止并分析根因

### ISS-017 - JWT令牌过期处理不当 ✅
- **解决日期**: 2024-01-16
- **负责人**: 张三
- **解决方案**: 实现自动令牌刷新机制，添加令牌过期前端处理
- **用时**: 1天
- **验证**: 通过集成测试验证

### ISS-016 - 商品分类层级查询性能差 ✅
- **解决日期**: 2024-01-16
- **负责人**: 王五
- **解决方案**: 使用递归CTE优化查询，添加适当索引
- **用时**: 0.5天
- **性能提升**: 查询时间从500ms降至50ms

### ISS-015 - Docker容器启动失败 ✅
- **解决日期**: 2024-01-15
- **负责人**: 李四
- **解决方案**: 修复Dockerfile依赖安装顺序，更新基础镜像
- **用时**: 2小时
- **影响**: 开发环境搭建

### ISS-014 - 用户密码加密强度不足 ✅
- **解决日期**: 2024-01-15
- **负责人**: 张三
- **解决方案**: 升级到bcrypt加密，增加salt轮数
- **用时**: 1小时
- **安全提升**: 密码破解难度提升1000倍

### ISS-013 - API响应格式不统一 ✅
- **解决日期**: 2024-01-14
- **负责人**: 全体开发
- **解决方案**: 创建统一响应格式类，重构所有API
- **用时**: 1天
- **影响**: 前端对接更顺畅

---

## 问题趋势分析

### 月度问题统计
```
2024-01月:
- 新发现: 23个
- 已解决: 18个
- 解决率: 78%
- 平均解决时间: 1.5天
```

### 问题类型趋势
1. **缺陷类**: 问题数量稳定，主要是新功能引入
2. **性能类**: 随着功能增加呈上升趋势，需要重点关注
3. **安全类**: 在设计阶段预防较好，问题较少
4. **环境类**: 主要集中在项目初期，现已稳定

### 解决效率分析
- **P0问题**: 平均解决时间 < 4小时
- **P1问题**: 平均解决时间 < 1天
- **P2问题**: 平均解决时间 < 3天
- **P3问题**: 平均解决时间 < 1周

---

## 问题预防措施

### 代码质量控制
1. **强制代码审查**: 所有代码必须经过review
2. **自动化测试**: CI/CD管道中集成测试检查
3. **静态分析**: 使用pylint、mypy等工具
4. **性能监控**: APM工具实时监控应用性能

### 设计阶段预防
1. **设计评审**: 重要功能必须经过设计评审
2. **安全检查**: 安全专家参与设计评审
3. **性能评估**: 关键接口进行性能预估
4. **容量规划**: 系统容量和扩展性设计

### 测试策略
1. **测试金字塔**: 单元测试 > 集成测试 > E2E测试
2. **性能测试**: 定期进行压力测试和负载测试
3. **安全测试**: 集成安全扫描工具
4. **回归测试**: 自动化回归测试套件

---

## 问题管理流程

### 问题报告流程
1. **发现问题** → 在问题跟踪系统中创建issue
2. **初步分析** → 技术负责人进行初步分析和优先级评估
3. **分配责任人** → 根据模块和技能分配给合适的开发人员
4. **制定解决方案** → 责任人分析问题并制定解决方案
5. **实施解决** → 按照解决方案实施修复
6. **测试验证** → 通过测试验证问题是否解决
7. **关闭问题** → 确认解决后关闭issue

### 优先级评估标准
- **P0 - 紧急**: 系统无法使用，影响所有用户
- **P1 - 高**: 核心功能异常，影响主要业务流程
- **P2 - 中**: 重要功能异常，有workaround方案
- **P3 - 低**: 次要功能异常，不影响核心业务

### 升级机制
- **P1问题超过1天未解决**: 升级到项目经理
- **P0问题超过4小时未解决**: 升级到技术总监
- **连续3个P1问题**: 召开技术评审会议

---

## 新增问题记录

### ISS-024 - pytest fixture依赖冲突导致单元测试连接错误数据库 🟠
- **状态**: 已解决
- **优先级**: P2 - 中 
- **类型**: 环境问题
- **发现日期**: 2024-09-21
- **报告人**: GitHub Copilot AI
- **负责人**: GitHub Copilot AI
- **解决日期**: 2024-09-21

**问题描述**:
单元测试执行时意外连接到MySQL集成测试数据库而非SQLite内存数据库，导致测试失败并报告MySQL连接拒绝错误。

**根本原因分析**:
1. **autouse fixture依赖强制初始化**: `tests/conftest.py`中的`@pytest.fixture(autouse=True)`装饰的fixture会强制pytest解析和初始化所有依赖的fixture，无视条件判断
2. **fixture设计缺陷**: `clean_integration_test_data(request, integration_test_engine)`直接依赖`integration_test_engine`参数，导致即使是单元测试也会尝试创建MySQL连接
3. **全局Mock配置错误**: `mock_setup` fixture中尝试patch不存在的模块属性，引发AttributeError

**影响范围**:
- **直接影响**: 所有单元测试无法正常运行
- **间接影响**: 开发效率降低，CI/CD流程中断
- **潜在风险**: 类似问题可能在其他模块测试中重现

**解决方案** (已实施):
```python
# 1. 修复autouse fixture依赖问题 - 使用延迟fixture获取
@pytest.fixture(autouse=True)
def clean_integration_test_data(request):
    """集成测试每个测试后自动清理数据库 - 确保测试隔离 [CHECK:TEST-002]"""
    # 只对集成测试生效
    if not any(marker.name == 'integration' for marker in request.node.iter_markers()):
        yield
        return
    
    # 只在集成测试时获取integration_test_engine
    try:
        integration_test_engine = request.getfixturevalue('integration_test_engine')
    except Exception:
        # 如果无法获取fixture，跳过清理
        yield
        return

# 2. 修复Mock配置问题
# 修复前: mocker.patch('app.core.redis_client.redis_client', mock_redis)  # ❌ 属性不存在
# 修复后: mocker.patch('app.core.redis_client.get_redis_connection', return_value=mock_redis)  # ✅

# 3. 移除错误的默认属性设置
# 修复前: mocker.patch.object.__defaults__ = (None, True)  # ❌ 方法对象无此属性
# 修复后: # 注释掉，在使用时单独指定autospec
```

**预防措施**:
1. **设计原则**: autouse fixture应避免直接依赖其他复杂fixture，使用延迟获取模式
2. **Mock验证**: 在Mock设置前验证目标属性是否存在
3. **测试隔离**: 确保单元测试和集成测试的fixture完全隔离

**检查点关联**: 
- **[CHECK:TEST-002]**: 测试数据一致性 - 单元测试必须使用SQLite内存数据库
- **相关文档**: `docs/standards/checkpoint-cards.md` TEST-002章节
- **快速查询关键词**: "autouse fixture", "pytest依赖冲突", "单元测试数据库配置"

**学到的经验**:
- pytest的autouse fixture会无条件解析所有依赖，需要使用`request.getfixturevalue()`延迟获取
- 复杂测试环境需要严格的fixture隔离设计
- Mock配置应该验证目标属性存在性

---

## 相关文档
- [每日工作日志](daily-log.md) - 问题发现和解决记录
- [当前冲刺状态](current-sprint.md) - 冲刺中的问题影响
- [里程碑进度](milestones.md) - 问题对里程碑的影响
- [MASTER工作流程](../MASTER.md) - 问题管理要求
