# 认证集成设计文档

## 文档说明
- **内容**: API认证集成的设计规范和实施计划
- **使用方法**: 认证中间件开发和API保护的指导文档
- **更新方法**: 认证策略变更时更新
- **引用关系**: 基于架构/security.md，指导各API模块认证实现
- **更新频率**: 安全策略调整时

## 设计目标

### 核心目标
1. **统一认证** - 所有API端点使用统一的认证机制
2. **权限分级** - 实现用户、管理员等不同权限等级
3. **安全加固** - 防止未授权访问和权限绕过
4. **性能优化** - 认证过程不影响API响应性能

### 成功标准
- ✅ 所有需要保护的API端点都有适当认证
- ✅ 权限检查逻辑清晰且无漏洞
- ✅ 认证错误有统一的处理和响应格式
- ✅ 认证性能满足系统要求(<50ms验证时间)

## 权限设计

### 权限等级定义
```python
# 权限等级
class UserRole:
    ANONYMOUS = "anonymous"     # 匿名用户 - 仅访问公开API
    USER = "user"              # 普通用户 - 访问个人数据和操作
    ADMIN = "admin"            # 管理员 - 管理所有用户和数据
    SUPER_ADMIN = "super_admin" # 超级管理员 - 系统配置权限
```

### API端点权限矩阵

| API端点分类 | 匿名用户 | 普通用户 | 管理员 | 说明 |
|------------|---------|---------|--------|------|
| **认证API** | ✅ | ✅ | ✅ | 注册、登录等公开接口 |
| **商品查询** | ✅ | ✅ | ✅ | 商品列表、详情、搜索 |
| **商品管理** | ❌ | ❌ | ✅ | 商品CRUD、状态管理 |
| **购物车** | ❌ | ✅ | ✅ | 个人购物车操作 |
| **订单查询** | ❌ | ✅(自己) | ✅(所有) | 订单查看权限 |
| **订单管理** | ❌ | ✅(创建) | ✅(所有) | 订单创建和管理 |
| **用户管理** | ❌ | ✅(自己) | ✅(所有) | 用户信息管理 |
| **分类管理** | ❌ | ❌ | ✅ | 商品分类CRUD |
| **证书管理** | ❌ | ❌ | ✅ | 质量证书管理 |

### 认证中间件设计

#### 1. 基础认证依赖
```python
# 认证依赖层次
get_current_user()           # 基础用户认证，允许None
get_current_active_user()    # 活跃用户认证，要求已激活
get_current_admin_user()     # 管理员权限认证
get_current_super_admin()    # 超级管理员权限认证
```

#### 2. 权限装饰器
```python
# 权限检查装饰器
@require_permission("user")      # 要求普通用户权限
@require_permission("admin")     # 要求管理员权限
@require_ownership()             # 要求资源所有权
```

## 实施计划

### 第1阶段：认证中间件完善 ✅ 已完成
**目标**: 扩展现有认证系统，支持权限分级

**任务列表**:
- [x] 在User模型添加role字段
- [x] 创建权限检查依赖函数
- [x] 实现资源所有权验证
- [x] 统一错误处理机制

**验收标准**:
- ✅ 所有认证依赖函数正常工作
- ✅ 权限检查逻辑无误
- ✅ 错误响应格式统一

### 第2阶段：商品API认证集成 ✅ 已完成
**目标**: 为商品管理API添加适当的认证保护

**现有端点分析**:
- `GET /api/products` - 商品列表 → **公开访问** ✅ 保持不变
- `POST /api/products` - 创建商品 → **管理员权限** ✅ 已保护
- `GET /api/products/{id}` - 商品详情 → **公开访问** ✅ 保持不变
- `PUT /api/products/{id}` - 更新商品 → **管理员权限** ✅ 已保护
- `DELETE /api/products/{id}` - 删除商品 → **管理员权限** ✅ 已保护

**实施任务**:
- [x] 为管理接口添加管理员权限检查
- [x] 保持查询接口公开访问
- [x] 添加错误处理
- [x] 更新API文档

### 第3阶段：购物车API认证集成 ✅ 已完成
**目标**: 为购物车API添加用户认证和所有权验证

**现有端点分析**:
- `POST /api/carts/items` - 添加商品 → **用户权限** ✅ 已保护
- `GET /api/carts` - 购物车详情 → **用户权限(自己)** ✅ 已保护
- `PUT /api/carts/items/{product_id}` - 更新数量 → **用户权限(自己)** ✅ 已保护
- `DELETE /api/carts/items/{product_id}` - 删除商品 → **用户权限(自己)** ✅ 已保护
- `GET /api/carts/summary` - 购物车摘要 → **用户权限(自己)** ✅ 已保护

**实施任务**:
- [x] 所有端点添加用户认证
- [x] 确保用户只能操作自己的购物车 (通过Redis key隔离)
- [x] 添加错误处理
- [x] 更新API文档

### 第4阶段：订单API认证集成 (明天)
**目标**: 为订单管理API添加认证和权限控制

### 第5阶段：其他API模块认证集成 (明天)
**目标**: 完成剩余API模块的认证集成

## 错误处理设计

### 统一错误响应格式
```python
class AuthError:
    UNAUTHORIZED = {
        "error": "unauthorized",
        "message": "认证凭据无效或已过期",
        "code": 401
    }
    
    FORBIDDEN = {
        "error": "forbidden", 
        "message": "权限不足，无法访问此资源",
        "code": 403
    }
    
    OWNERSHIP_REQUIRED = {
        "error": "ownership_required",
        "message": "只能操作自己的资源",
        "code": 403
    }
```

### 异常处理流程
1. **认证失败** → 返回401 Unauthorized
2. **权限不足** → 返回403 Forbidden  
3. **资源所有权** → 返回403 Forbidden (特定消息)
4. **令牌过期** → 返回401 + refresh提示

## 性能考虑

### 认证缓存策略
- **JWT验证缓存** - 相同token 5分钟内跳过重复验证
- **用户权限缓存** - 用户角色信息缓存10分钟
- **数据库查询优化** - 使用索引优化用户查询

### 安全措施
- **令牌刷新机制** - 短期access token + 长期refresh token
- **异常登录检测** - 记录异常IP和时间
- **API限流** - 防止暴力破解和DDOS攻击

## 测试策略

### 单元测试
- [ ] 认证中间件功能测试
- [ ] 权限检查逻辑测试
- [ ] 错误处理机制测试

### 集成测试  
- [ ] API端点认证测试
- [ ] 权限矩阵验证测试
- [ ] 错误响应格式测试

### 安全测试
- [ ] 权限绕过测试
- [ ] JWT篡改测试
- [ ] 未授权访问测试

---

## 实施检查清单

### 开发前检查
- [x] 阅读安全架构文档 (docs/architecture/security.md)
- [x] 阅读用户认证API文档
- [x] 确认命名规范合规
- [x] 理解现有认证实现

### 开发中检查
- [ ] 每个API端点权限设计合理
- [ ] 错误处理逻辑完整
- [ ] 性能优化措施就位
- [ ] 安全漏洞检查

### 开发后验证
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 安全测试通过
- [ ] API文档更新
- [ ] 命名规范检查通过

---

*设计文档创建时间: 2025-09-11*  
*下一次更新: 认证集成完成后*
