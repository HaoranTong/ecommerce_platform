# æ”¯ä»˜æ¨¡å—è®¤è¯é›†æˆè®¾è®¡

## æ–‡æ¡£è¯´æ˜
- **å†…å®¹**: æ”¯ä»˜æ¨¡å—çš„è®¤è¯é›†æˆè®¾è®¡å’Œå®‰å…¨è§„èŒƒ
- **ä½¿ç”¨æ–¹æ³•**: æ”¯ä»˜APIå¼€å‘çš„è®¤è¯æŒ‡å¯¼æ–‡æ¡£
- **æ›´æ–°æ–¹æ³•**: æ”¯ä»˜ç­–ç•¥å’Œå®‰å…¨è¦æ±‚å˜æ›´æ—¶æ›´æ–°
- **å¼•ç”¨å…³ç³»**: åŸºäºè®¤è¯é›†æˆè®¾è®¡æ–‡æ¡£ï¼ŒæŒ‡å¯¼æ”¯ä»˜æ¨¡å—å¼€å‘
- **æ›´æ–°é¢‘ç‡**: æ”¯ä»˜å®‰å…¨ç­–ç•¥è°ƒæ•´æ—¶

## æ”¯ä»˜å®‰å…¨è®¾è®¡åŸåˆ™

### æ ¸å¿ƒå®‰å…¨è¦æ±‚
1. **ä¸¥æ ¼è®¤è¯**: æ‰€æœ‰æ”¯ä»˜ç›¸å…³æ“ä½œå¿…é¡»ç»è¿‡ç”¨æˆ·è®¤è¯
2. **æƒé™éªŒè¯**: ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ”¯ä»˜è®¢å•
3. **ç®¡ç†å‘˜ç›‘æ§**: ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ”¯ä»˜è®°å½•
4. **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**: æ”¯ä»˜å‡­æ®å’Œä¸ªäººä¿¡æ¯åŠ å¯†å­˜å‚¨
5. **æ“ä½œå®¡è®¡**: æ‰€æœ‰æ”¯ä»˜æ“ä½œå¿…é¡»è®°å½•å®¡è®¡æ—¥å¿—

### æ”¯ä»˜æƒé™çŸ©é˜µ

| æ”¯ä»˜APIç«¯ç‚¹ | åŒ¿åç”¨æˆ· | æ™®é€šç”¨æˆ· | ç®¡ç†å‘˜ | è¯´æ˜ |
|------------|---------|---------|--------|------|
| **æ”¯ä»˜æ–¹å¼æŸ¥è¯¢** | âœ… | âœ… | âœ… | è·å–å¯ç”¨æ”¯ä»˜æ–¹å¼ |
| **åˆ›å»ºæ”¯ä»˜è®¢å•** | âŒ | âœ…(è‡ªå·±) | âœ…(ä»»æ„) | ä¸ºè®¢å•åˆ›å»ºæ”¯ä»˜ |
| **æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€** | âŒ | âœ…(è‡ªå·±) | âœ…(æ‰€æœ‰) | æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢ |
| **æ”¯ä»˜å›è°ƒå¤„ç†** | ğŸ”’ | ğŸ”’ | ğŸ”’ | ä»…æ”¯ä»˜å¹³å°å›è°ƒ |
| **æ”¯ä»˜è®°å½•æŸ¥è¯¢** | âŒ | âœ…(è‡ªå·±) | âœ…(æ‰€æœ‰) | å†å²æ”¯ä»˜è®°å½• |
| **é€€æ¬¾ç”³è¯·** | âŒ | âœ…(è‡ªå·±) | âœ…(ä»»æ„) | ç”³è¯·é€€æ¬¾ |
| **é€€æ¬¾å¤„ç†** | âŒ | âŒ | âœ… | å¤„ç†é€€æ¬¾ç”³è¯· |
| **æ”¯ä»˜é…ç½®ç®¡ç†** | âŒ | âŒ | âœ… | æ”¯ä»˜æ¸ é“é…ç½® |

## V1.0 Mini-MVPæ”¯ä»˜è®¤è¯èŒƒå›´

### ç¬¬ä¸€ç‰ˆæœ¬æ”¯ä»˜åŠŸèƒ½
**ç›®æ ‡**: å®ç°åŸºç¡€çš„å¾®ä¿¡æ”¯ä»˜é›†æˆï¼Œæ»¡è¶³Mini-MVPéœ€æ±‚

#### å¿…éœ€APIç«¯ç‚¹
1. **POST /api/payments** - åˆ›å»ºæ”¯ä»˜è®¢å•
   - **æƒé™**: ç”¨æˆ·è®¤è¯ + è®¢å•æ‰€æœ‰æƒéªŒè¯
   - **åŠŸèƒ½**: ä¸ºå·²åˆ›å»ºçš„è®¢å•ç”Ÿæˆæ”¯ä»˜å•

2. **GET /api/payments/{payment_id}** - æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
   - **æƒé™**: ç”¨æˆ·è®¤è¯ + æ”¯ä»˜å•æ‰€æœ‰æƒéªŒè¯
   - **åŠŸèƒ½**: æŸ¥è¯¢æ”¯ä»˜è¿›åº¦å’ŒçŠ¶æ€

3. **POST /api/payments/callback/wechat** - å¾®ä¿¡æ”¯ä»˜å›è°ƒ
   - **æƒé™**: å¾®ä¿¡ç­¾åéªŒè¯ï¼ˆæ— éœ€ç”¨æˆ·è®¤è¯ï¼‰
   - **åŠŸèƒ½**: å¤„ç†å¾®ä¿¡æ”¯ä»˜ç»“æœé€šçŸ¥

4. **GET /api/payments** - æ”¯ä»˜è®°å½•æŸ¥è¯¢
   - **æƒé™**: ç”¨æˆ·è®¤è¯ + æ•°æ®éš”ç¦»
   - **åŠŸèƒ½**: æŸ¥è¯¢ä¸ªäººæ”¯ä»˜å†å²

#### ç®¡ç†å‘˜APIç«¯ç‚¹
1. **GET /api/admin/payments** - æ‰€æœ‰æ”¯ä»˜è®°å½•
   - **æƒé™**: ç®¡ç†å‘˜è®¤è¯
   - **åŠŸèƒ½**: ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰æ”¯ä»˜è®°å½•

2. **POST /api/admin/payments/{payment_id}/refund** - å¤„ç†é€€æ¬¾
   - **æƒé™**: ç®¡ç†å‘˜è®¤è¯
   - **åŠŸèƒ½**: ç®¡ç†å‘˜å¤„ç†é€€æ¬¾ç”³è¯·

## è®¤è¯é›†æˆå®ç°

### 1. æ”¯ä»˜APIè®¤è¯ä¾èµ–
```python
# æ”¯ä»˜æ¨¡å—è®¤è¯ä¾èµ–
from app.auth import (
    get_current_active_user,     # ç”¨æˆ·è®¤è¯
    get_current_admin_user,      # ç®¡ç†å‘˜è®¤è¯  
    require_ownership,           # æ‰€æœ‰æƒéªŒè¯
    check_resource_ownership     # èµ„æºæ‰€æœ‰æƒä¾èµ–
)
```

### 2. æ”¯ä»˜å•æ‰€æœ‰æƒéªŒè¯
```python
def verify_payment_ownership(payment_id: int, current_user: User, db: Session):
    """éªŒè¯æ”¯ä»˜å•æ‰€æœ‰æƒ"""
    payment = db.query(Payment).filter(Payment.id == payment_id).first()
    if not payment:
        raise HTTPException(404, "æ”¯ä»˜å•ä¸å­˜åœ¨")
    
    # é€šè¿‡è®¢å•éªŒè¯æ‰€æœ‰æƒ
    order = db.query(Order).filter(Order.id == payment.order_id).first()
    if not require_ownership(order.user_id, current_user):
        raise HTTPException(403, "æ— æƒè®¿é—®æ­¤æ”¯ä»˜å•")
    
    return payment
```

### 3. æ”¯ä»˜å›è°ƒå®‰å…¨éªŒè¯
```python
def verify_wechat_signature(data: dict, signature: str) -> bool:
    """éªŒè¯å¾®ä¿¡æ”¯ä»˜å›è°ƒç­¾å"""
    # å®ç°å¾®ä¿¡æ”¯ä»˜ç­¾åéªŒè¯é€»è¾‘
    # ä¸éœ€è¦ç”¨æˆ·è®¤è¯ï¼Œä½†éœ€è¦éªŒè¯æ¥æº
    pass
```

## æ•°æ®æ¨¡å‹è®¾è®¡

### Paymentæ¨¡å‹å®‰å…¨å­—æ®µ
```python
class Payment(Base):
    __tablename__ = 'payments'
    
    id = Column(Integer, primary_key=True)
    order_id = Column(Integer, ForeignKey('orders.id'), nullable=False)
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)  # æ‰€æœ‰æƒå­—æ®µ
    
    # æ”¯ä»˜ä¿¡æ¯
    payment_method = Column(String(50), nullable=False)  # 'wechat', 'alipay'
    amount = Column(DECIMAL(10, 2), nullable=False)
    currency = Column(String(3), default='CNY')
    
    # çŠ¶æ€å­—æ®µ
    status = Column(String(20), default='pending')  # 'pending', 'paid', 'failed', 'refunded'
    
    # ç¬¬ä¸‰æ–¹ä¿¡æ¯ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
    external_payment_id = Column(String(200))  # å¾®ä¿¡è®¢å•å·
    external_transaction_id = Column(String(200))  # å¾®ä¿¡äº¤æ˜“å·
    
    # æ—¶é—´æˆ³
    created_at = Column(DateTime, server_default=func.now())
    paid_at = Column(DateTime, nullable=True)
    
    # å…³ç³»
    order = relationship("Order", back_populates="payments")
    user = relationship("User", back_populates="payments")
```

## å®‰å…¨æªæ–½

### 1. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- æ”¯ä»˜å‡­æ®åŠ å¯†å­˜å‚¨
- ä¸ªäººä¿¡æ¯è„±æ•æ˜¾ç¤º
- æ—¥å¿—ä¸­ä¸è®°å½•æ•æ„Ÿä¿¡æ¯

### 2. é˜²é‡æ”¾æ”»å‡»
- æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§æ£€æŸ¥
- è¯·æ±‚æ—¶é—´æˆ³éªŒè¯
- è®¢å•çŠ¶æ€é”å®šæœºåˆ¶

### 3. é‡‘é¢éªŒè¯
- è®¢å•é‡‘é¢ä¸æ”¯ä»˜é‡‘é¢ä¸€è‡´æ€§æ£€æŸ¥
- é˜²æ­¢é‡‘é¢ç¯¡æ”¹
- å¸ç§ä¸€è‡´æ€§éªŒè¯

### 4. å®¡è®¡æ—¥å¿—
```python
class PaymentAuditLog(Base):
    __tablename__ = 'payment_audit_logs'
    
    id = Column(Integer, primary_key=True)
    payment_id = Column(Integer, ForeignKey('payments.id'))
    user_id = Column(Integer, ForeignKey('users.id'))
    action = Column(String(50))  # 'create', 'pay', 'refund', 'cancel'
    old_status = Column(String(20))
    new_status = Column(String(20))
    ip_address = Column(String(45))
    user_agent = Column(Text)
    created_at = Column(DateTime, server_default=func.now())
```

## é”™è¯¯å¤„ç†

### æ”¯ä»˜ä¸“ç”¨é”™è¯¯å“åº”
```python
class PaymentError:
    PAYMENT_NOT_FOUND = {
        "error": "payment_not_found",
        "message": "æ”¯ä»˜å•ä¸å­˜åœ¨",
        "code": 404
    }
    
    PAYMENT_OWNERSHIP_REQUIRED = {
        "error": "payment_ownership_required", 
        "message": "åªèƒ½æ“ä½œè‡ªå·±çš„æ”¯ä»˜å•",
        "code": 403
    }
    
    INVALID_PAYMENT_STATUS = {
        "error": "invalid_payment_status",
        "message": "æ”¯ä»˜å•çŠ¶æ€ä¸å…è®¸æ­¤æ“ä½œ", 
        "code": 400
    }
    
    PAYMENT_AMOUNT_MISMATCH = {
        "error": "payment_amount_mismatch",
        "message": "æ”¯ä»˜é‡‘é¢ä¸è®¢å•é‡‘é¢ä¸ç¬¦",
        "code": 400
    }
```

## å®æ–½è®¡åˆ’

### é˜¶æ®µ1: æ”¯ä»˜æ¨¡å‹å’ŒåŸºç¡€è®¤è¯ (1å¤©)
- [ ] åˆ›å»ºPaymentæ¨¡å‹å’Œæ•°æ®åº“è¿ç§»
- [ ] å®ç°æ”¯ä»˜å•æ‰€æœ‰æƒéªŒè¯å‡½æ•°
- [ ] åˆ›å»ºæ”¯ä»˜APIè·¯ç”±æ¡†æ¶

### é˜¶æ®µ2: å¾®ä¿¡æ”¯ä»˜é›†æˆ (2å¤©)  
- [ ] å¾®ä¿¡æ”¯ä»˜SDKé›†æˆ
- [ ] æ”¯ä»˜åˆ›å»ºAPI + ç”¨æˆ·è®¤è¯
- [ ] æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢API + æ‰€æœ‰æƒéªŒè¯
- [ ] å¾®ä¿¡æ”¯ä»˜å›è°ƒå¤„ç†

### é˜¶æ®µ3: ç®¡ç†å’Œå®¡è®¡åŠŸèƒ½ (1å¤©)
- [ ] ç®¡ç†å‘˜æ”¯ä»˜æŸ¥è¯¢API
- [ ] é€€æ¬¾åŠŸèƒ½å’Œç®¡ç†å‘˜æƒé™
- [ ] å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

### é˜¶æ®µ4: å®‰å…¨åŠ å›ºå’Œæµ‹è¯• (1å¤©)
- [ ] æ•æ„Ÿä¿¡æ¯åŠ å¯†
- [ ] å®‰å…¨æµ‹è¯•å’Œæ¼æ´æ£€æŸ¥
- [ ] ç«¯åˆ°ç«¯æ”¯ä»˜æµç¨‹æµ‹è¯•

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- âœ… ç”¨æˆ·å¯ä»¥ä¸ºè‡ªå·±çš„è®¢å•åˆ›å»ºæ”¯ä»˜
- âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ”¯ä»˜è®°å½•
- âœ… ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ”¯ä»˜
- âœ… æ”¯ä»˜å›è°ƒæ­£ç¡®å¤„ç†çŠ¶æ€æ›´æ–°
- âœ… æ‰€æœ‰æ”¯ä»˜æ“ä½œæœ‰å®¡è®¡è®°å½•

### å®‰å…¨éªŒæ”¶
- âœ… æ— æœªæˆæƒæ”¯ä»˜è®¿é—®æ¼æ´
- âœ… æ•æ„Ÿä¿¡æ¯ä¸æ³„éœ²
- âœ… æ”¯ä»˜é‡‘é¢æ— æ³•ç¯¡æ”¹
- âœ… å›è°ƒç­¾åéªŒè¯æ­£ç¡®
- âœ… é˜²é‡æ”¾æ”»å‡»æœºåˆ¶æœ‰æ•ˆ

### æ€§èƒ½éªŒæ”¶
- âœ… æ”¯ä»˜åˆ›å»ºå“åº”æ—¶é—´ < 1ç§’
- âœ… æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢å“åº”æ—¶é—´ < 500ms
- âœ… æ”¯ä»˜å›è°ƒå¤„ç†æ—¶é—´ < 2ç§’
- âœ… æ”¯æŒå¹¶å‘æ”¯ä»˜è¯·æ±‚

---

**è®¾è®¡æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-09-11  
**ç›®æ ‡å®Œæˆæ—¶é—´**: æ”¯ä»˜æ¨¡å—å¼€å‘å¼€å§‹å‰  
**ä¸‹ä¸€æ¬¡æ›´æ–°**: æ”¯ä»˜é›†æˆå®æ–½è¿‡ç¨‹ä¸­
