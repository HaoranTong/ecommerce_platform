<!--
文档说明：
- 内容：系统技术架构总览，包括技术选型、架构决策、系统设计原则
- 使用方法：架构设计和技术选型的指导文档，开发前必读
- 更新方法：重大技术架构变更时更新，需要技术负责人确认
- 引用关系：被其他架构文档和模块设计文档引用
- 更新频率：重大架构变更时
-->

# 技术架构总览

## 架构设计原则

### 核心原则
1. **契约优先 (Contract-First)** - 接口、数据模型、状态机在开发前冻结
2. **适配器抽象 (Adapter Pattern)** - 第三方集成通过适配器接口实现
3. **功能开关 (Feature Flag)** - 每个功能支持独立启用/禁用
4. **配置驱动 (Configuration-Driven)** - 业务规则通过配置文件管理
5. **事件驱动 (Event-Driven)** - 重要操作发布事件，支持异步处理
6. **移动优先 (Mobile-First)** - 优先优化移动端性能和用户体验
7. **社交驱动 (Social-Driven)** - 支持社交分享、拼团等社交电商功能
8. **数据驱动 (Data-Driven)** - 基于用户行为和业务数据优化决策

### 架构演进原则
- **前瞻性设计** - 从 Mini-MVP 开始考虑最终产品需求
- **可扩展架构** - 所有模块支持功能扩展，避免大量重构
- **接口稳定性** - API 设计支持向后兼容和版本演进
- **数据模型前瞻** - 数据库设计预留扩展字段

## 系统架构

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户层 (UI)    │    │   管理层 (Admin) │    │   第三方集成     │
│ 微信小程序/H5/PC │    │   后台管理系统   │    │ 支付/物流/AI/IoT │
│ 分销商小程序    │    │   供应商后台     │    │ 区块链/短信/OSS  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └─────────┐       ┌─────┴─────┐         ┌───────┘
                   │       │           │         │
         ┌─────────▼───────▼───────────▼─────────▼─────────┐
         │                API 网关层                       │
         │    (路由/认证/限流/监控/日志/社交分享)            │
         └─────────────────┬───────────────────────────────┘
                           │
         ┌─────────────────▼───────────────────────────────┐
         │                核心业务服务层                   │
         │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │ │用户认证 │ │商品管理 │ │订单管理 │ │支付结算 │ │
         │ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
         │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │ │购物车   │ │库存管理 │ │批次溯源 │ │会员系统 │ │
         │ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
         └─────────────────┬───────────────────────────────┘
                           │
         ┌─────────────────▼───────────────────────────────┐
         │              支撑业务服务层                     │
         │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │ │分销商   │ │营销活动 │ │通知服务 │ │客服系统 │ │
         │ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
         │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │ │社交功能 │ │供应商   │ │风控系统 │ │数据分析 │ │
         │ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
         └─────────────────┬───────────────────────────────┘
                           │
         ┌─────────────────▼───────────────────────────────┐
         │             基础设施服务层                      │
         │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │ │物流管理 │ │AI推荐   │ │区块链   │ │IoT集成  │ │
         │ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
         └─────────────────┬───────────────────────────────┘
                           │
         ┌─────────────────▼───────────────────────────────┐
         │                数据存储层                       │
         │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │ │ MySQL   │ │ Redis   │ │文件存储 │ │消息队列 │ │
         │ │(主数据) │ │(缓存)   │ │(OSS)   │ │(RabbitMQ)│ │
         │ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
         │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │ │区块链DB │ │向量DB   │ │时序DB   │ │搜索引擎 │ │
         │ │(溯源)   │ │(AI推荐) │ │(IoT)    │ │(ES)     │ │
         │ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
         └─────────────────────────────────────────────────┘
```

### 技术栈选型

#### 后端技术栈
- **应用框架**: FastAPI (Python 3.11+)
- **数据库**: MySQL 8.0+ (主数据库)
- **缓存**: Redis 7.0+ (缓存 + 会话 + 队列)
- **ORM**: SQLAlchemy + Alembic (数据模型 + 迁移)
- **认证**: JWT Token + OAuth 2.0
- **异步处理**: Celery + RabbitMQ (后期)

#### 前端技术栈
- **移动端**: 微信小程序原生开发
- **管理后台**: Vue.js 3.x + Element Plus (后期)
- **API文档**: OpenAPI 3.0 + Swagger UI

#### 基础设施
- **容器化**: Docker + Docker Compose
- **Web服务器**: Nginx (反向代理 + 静态文件)
- **应用服务器**: Uvicorn + Gunicorn
- **监控**: Prometheus + Grafana (后期)
- **日志**: 结构化日志 + ELK Stack (后期)

#### 第三方集成
- **支付**: 微信支付 + 支付宝 + 银行卡 + 数字人民币
- **短信**: 腾讯云短信服务
- **对象存储**: 腾讯云 COS / 阿里云 OSS
- **CDN**: 腾讯云 CDN / 阿里云 CDN
- **区块链**: 腾讯云TBaaS / 蚂蚁链 (溯源存证)
- **AI服务**: 腾讯云AI / 百度AI (推荐算法)
- **IoT平台**: 腾讯云IoT / 阿里云IoT (设备数据采集)
- **地图服务**: 腾讯地图 / 高德地图 (物流配送)
- **实名认证**: 腾讯云身份验证 (供应商认证)

## 模块架构

### 服务拆分原则
1. **业务边界清晰** - 按照业务领域进行服务拆分
2. **数据独立** - 每个服务拥有独立的数据存储
3. **接口标准** - 统一的 API 设计和通信规范
4. **故障隔离** - 服务间故障不相互影响

### 核心服务模块（基于DDD边界设计）
```
app/
├── api/                    # API 路由层
│   ├── user_routes.py      # 用户认证服务 (user-service)
│   ├── product_routes.py   # 商品管理服务 (product-service)
│   ├── cart_routes.py      # 购物车服务 (独立Redis存储)
│   ├── order_routes.py     # 订单管理服务 (order-service)
│   ├── payment_routes.py   # 支付服务 (checkout-service)
│   ├── category_routes.py  # 分类管理 (product-service的一部分)
│   ├── member_routes.py    # 会员系统路由 (待创建)
│   ├── distributor_routes.py # 分销商管理路由 (待创建)
│   ├── batch_routes.py     # 批次溯源路由 (待创建)
│   ├── marketing_routes.py # 营销活动路由 (待创建)
│   └── social_routes.py    # 社交功能路由 (待创建)
├── models/                 # 数据模型层
├── services/               # 业务逻辑层
├── adapters/               # 第三方适配器层
│   ├── payment/           # 支付适配器
│   ├── blockchain/        # 区块链适配器
│   ├── ai/               # AI服务适配器
│   └── iot/              # IoT设备适配器
└── core/                   # 核心组件层
```

### DDD微服务边界映射
**当前模块化实现 → 未来微服务边界**:
- `user_routes.py` → `user-service` (用户管理和认证)
- `product_routes.py + category_routes.py` → `product-service` (商品管理和分类)
- `cart_routes.py` → `cart-service` (购物车，基于Redis)
- `order_routes.py` → `order-service` (订单处理和状态管理)
- `payment_routes.py` → `checkout-service` (结算和支付流程)

**农产品电商特色微服务**:
- `batch_routes.py` → `batch-service` (批次管理和溯源)
- `member_routes.py` → `member-service` (会员体系和积分)
- `distributor_routes.py` → `distributor-service` (分销商管理)
- `marketing_routes.py` → `campaign-service` (营销活动管理)
- `social_routes.py` → `social-service` (社交功能)

**支撑服务模块**:
- `inventory-service` - 库存管理和预警
- `notification-service` - 消息通知和推送
- `customer-service` - 客服系统和工单
- `analytics-service` - 数据分析和报表
- `risk-service` - 风控和反欺诈
- `logistics-service` - 物流和配送
- `supplier-service` - 供应商管理

**基础设施服务**:
- `ai-service` - AI推荐和分析
- `trace-service` - 溯源和区块链
- `iot-service` - IoT设备集成
- `ledger-service` - 财务和对账

**技术基础设施模块**:
- `application-core` - FastAPI应用入口和路由注册
- `database-core` - SQLAlchemy连接池和会话管理
- `data-models` - 所有业务实体的ORM模型定义
- `redis-cache` - Redis连接管理和缓存策略
- `database-utils` - 数据库工具脚本和测试辅助
- `recommendation-system` - 商品推荐算法和实时推荐

### 数据架构
- **主数据库**: MySQL - 事务性数据存储
- **缓存层**: Redis - 会话、购物车、热点数据、分布式锁
- **文件存储**: OSS - 图片、文档等静态文件
- **搜索引擎**: Elasticsearch - 商品搜索、用户行为分析
- **区块链存储**: 区块链节点 - 溯源数据存证
- **向量数据库**: Pinecone/Milvus - AI推荐算法
- **时序数据库**: InfluxDB - IoT设备数据、监控数据
- **消息队列**: RabbitMQ - 异步任务、事件驱动

## 安全架构

### 认证与授权
- **用户认证**: JWT Token + 微信登录
- **API安全**: Token 验证 + Rate Limiting
- **权限控制**: RBAC 基于角色的访问控制
- **数据加密**: HTTPS + 数据库字段加密

### 数据安全
- **传输安全**: TLS 1.3 加密传输
- **存储安全**: 敏感数据加密存储
- **访问控制**: 最小权限原则
- **审计日志**: 完整的操作审计追踪

## 性能架构

### 缓存策略
```
L1: 应用内存缓存 (本地缓存)
L2: Redis 分布式缓存 (热点数据)
L3: CDN 边缘缓存 (静态资源)
```

### 数据库优化
- **读写分离**: 主库写入，从库读取
- **连接池**: 数据库连接池管理
- **索引优化**: 基于查询模式的索引设计
- **分库分表**: 基于业务的水平拆分 (后期)

### 接口优化
- **异步处理**: 耗时操作异步执行
- **批量操作**: 减少网络请求次数
- **数据压缩**: 响应数据压缩传输
- **CDN加速**: 静态资源 CDN 分发

## 部署架构

### 环境划分
- **开发环境**: 本地 Docker Compose
- **测试环境**: 云服务器 + CI/CD
- **生产环境**: 云服务器集群 + 负载均衡

### 容器化部署
```yaml
services:
  - api-server     # FastAPI 应用服务
  - mysql          # MySQL 数据库
  - redis          # Redis 缓存
  - nginx          # 反向代理
  - monitor        # 监控服务
```

### CI/CD 流程
```
代码提交 → 自动测试 → 构建镜像 → 自动部署 → 健康检查
```

## 监控与运维

### 监控体系
- **应用监控**: 性能指标、错误率、响应时间
- **基础设施监控**: CPU、内存、磁盘、网络
- **业务监控**: 关键业务指标实时监控
- **日志监控**: 结构化日志收集和分析

### 告警机制
- **阈值告警**: 基于指标阈值的自动告警
- **异常检测**: 基于机器学习的异常检测
- **通知渠道**: 短信、邮件、企业微信
- **值班机制**: 7x24 小时值班响应

## 扩展规划

### 水平扩展
- **无状态设计**: 应用服务无状态，支持水平扩展
- **负载均衡**: 基于轮询和权重的负载分发
- **自动扩缩容**: 基于负载的自动扩缩容
- **容灾备份**: 多可用区部署和容灾切换

### 功能扩展
- **微服务化**: 逐步拆分为独立的微服务
- **API网关**: 统一的 API 网关和服务治理
- **服务网格**: 服务间通信和治理 (后期)
- **容器编排**: Kubernetes 集群管理 (后期)
